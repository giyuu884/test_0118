"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.detectFileType = void 0;
const make_header_1 = require("./boxes/webm/make-header");
const matchesPattern = (pattern) => {
    return (data) => {
        return pattern.every((value, index) => data[index] === value);
    };
};
const isRiff = (data) => {
    const riffPattern = new Uint8Array([0x52, 0x49, 0x46, 0x46]);
    return matchesPattern(riffPattern)(data.subarray(0, 4));
};
const isWebm = (data) => {
    return matchesPattern(make_header_1.webmPattern)(data.subarray(0, 4));
};
const isIsoBaseMedia = (data) => {
    const isoBaseMediaMp4Pattern = new TextEncoder().encode('ftyp');
    return matchesPattern(isoBaseMediaMp4Pattern)(data.subarray(4, 8));
};
const isTransportStream = (data) => {
    return data[0] === 0x47 && data[188] === 0x47;
};
const isMp3 = (data) => {
    const mpegPattern = new Uint8Array([0xff, 0xf3, 0xe4, 0x64]);
    return matchesPattern(mpegPattern)(data.subarray(0, 4));
};
const isGif = (data) => {
    const gifPattern = new Uint8Array([0x47, 0x49, 0x46, 0x38]);
    return matchesPattern(gifPattern)(data.subarray(0, 4));
};
const isPng = (data) => {
    const pngPattern = new Uint8Array([0x89, 0x50, 0x4e, 0x47]);
    return matchesPattern(pngPattern)(data.subarray(0, 4));
};
const isBmp = (data) => {
    const bmpPattern = new Uint8Array([0x42, 0x4d]);
    return matchesPattern(bmpPattern)(data.subarray(0, 2));
};
const isJpeg = (data) => {
    const jpegPattern = new Uint8Array([0xff, 0xd8]);
    const jpeg = matchesPattern(jpegPattern)(data.subarray(0, 2));
    if (!jpeg) {
        return false;
    }
    const width = data[6] * 256 + data[7];
    const height = data[8] * 256 + data[9];
    console.log(width, height);
    return true;
};
const isWebp = (data) => {
    const webpPattern = new Uint8Array([0x52, 0x49, 0x46, 0x46]);
    return matchesPattern(webpPattern)(data.subarray(0, 4));
};
const detectFileType = (data) => {
    if (isWebp(data)) {
        return 'webp';
    }
    if (isRiff(data)) {
        return 'riff';
    }
    if (isWebm(data)) {
        return 'webm';
    }
    if (isIsoBaseMedia(data)) {
        return 'iso-base-media';
    }
    if (isTransportStream(data)) {
        return 'transport-stream';
    }
    if (isMp3(data)) {
        return 'mp3';
    }
    if (isGif(data)) {
        return 'gif';
    }
    if (isPng(data)) {
        return 'png';
    }
    if (isBmp(data)) {
        return 'bmp';
    }
    if (isJpeg(data)) {
        return 'jpeg';
    }
    return 'unknown';
};
exports.detectFileType = detectFileType;
