<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>コーヒー豆ビギナーズガイド</title>
    <meta
      name="description"
      content="初心者向けにコーヒー豆の特徴を10段階評価で紹介する、見やすく洗練された1ページサイト。"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- 動画モーダル -->
    <div class="video-modal-overlay is-active" id="videoModal">
      <div class="video-modal">
        <button class="video-modal-close" id="closeVideoModal" aria-label="閉じる">&times;</button>
        <video
          id="introVideo"
          class="modal-video"
          autoplay
          muted
          playsinline
        >
          <source src="coffee-intro.mp4" type="video/mp4" />
        </video>
        <div class="video-modal-controls">
          <button class="video-sound-btn" id="videoSoundBtn">
            🔇 音声ON
          </button>
          <button class="video-skip-btn" id="skipVideoBtn">
            スキップ →
          </button>
        </div>
      </div>
    </div>

    <header class="site-header">
      <div class="container">
        <p class="eyebrow">Coffee Beans Guide</p>
        <h1>コーヒー豆ビギナーズガイド</h1>
        <p class="lead">
          代表的な豆を「酸味・味の濃さ・焙煎度」を10段階でまとめました。
        </p>
        <div class="note">
          <span>評価の目安:</span>
          <span>1 = 軽い / 浅い</span>
          <span>10 = しっかり / 深い</span>
        </div>
        <button class="search-cta" id="openSearchModal">
          コーヒー豆を検索する
        </button>
        <div class="coffee-bean-kun-area">
          <p class="trivia-display">
            <span class="trivia-label">☕ 今日の豆知識:</span>
            <span class="trivia-text" id="triviaText">読み込み中...</span>
          </p>
          <button class="chat-button" id="openChatModal">
            コーヒー豆くんと会話する
          </button>
        </div>
      </div>
    </header>

    <!-- 検索モーダル -->
    <div class="modal-overlay" id="searchModal">
      <div class="modal">
        <div class="modal-header">
          <h2>コーヒー豆を検索</h2>
          <button class="modal-close" id="closeModal" aria-label="閉じる">&times;</button>
        </div>
        <div class="modal-body">
          <div class="search-criteria">
            <div class="criteria-group">
              <label>酸味</label>
              <div class="criteria-buttons" data-criteria="acidity">
                <button type="button" data-value="1">1</button>
                <button type="button" data-value="2">2</button>
                <button type="button" data-value="3">3</button>
                <button type="button" data-value="4">4</button>
                <button type="button" data-value="5">5</button>
                <button type="button" data-value="6">6</button>
                <button type="button" data-value="7">7</button>
                <button type="button" data-value="8">8</button>
                <button type="button" data-value="9">9</button>
                <button type="button" data-value="10">10</button>
              </div>
            </div>
            <div class="criteria-group">
              <label>味の濃さ</label>
              <div class="criteria-buttons" data-criteria="body">
                <button type="button" data-value="1">1</button>
                <button type="button" data-value="2">2</button>
                <button type="button" data-value="3">3</button>
                <button type="button" data-value="4">4</button>
                <button type="button" data-value="5">5</button>
                <button type="button" data-value="6">6</button>
                <button type="button" data-value="7">7</button>
                <button type="button" data-value="8">8</button>
                <button type="button" data-value="9">9</button>
                <button type="button" data-value="10">10</button>
              </div>
            </div>
            <div class="criteria-group">
              <label>焙煎度</label>
              <div class="criteria-buttons" data-criteria="roast">
                <button type="button" data-value="1">1</button>
                <button type="button" data-value="2">2</button>
                <button type="button" data-value="3">3</button>
                <button type="button" data-value="4">4</button>
                <button type="button" data-value="5">5</button>
                <button type="button" data-value="6">6</button>
                <button type="button" data-value="7">7</button>
                <button type="button" data-value="8">8</button>
                <button type="button" data-value="9">9</button>
                <button type="button" data-value="10">10</button>
              </div>
            </div>
          </div>
          <p class="search-error" id="searchError"></p>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="backBtn">戻る</button>
          <button class="btn-primary" id="searchBtn">検索する</button>
        </div>
      </div>
    </div>

    <main class="container">
      <!-- 検索結果エリア（初期非表示） -->
      <section class="section search-results-section" id="searchResultsSection" style="display: none;">
        <div class="section-header">
          <h2 id="searchResultsTitle">検索結果</h2>
          <p id="searchResultsDesc"></p>
          <button class="btn-reset" id="resetSearch">もとの画面に戻る</button>
        </div>
        <div class="grid" id="searchResultsGrid"></div>
      </section>

      <!-- おすすめ一覧エリア（初期非表示） -->
      <section class="section recommend-section" id="recommendSection" style="display: none;">
        <div class="section-header">
          <h2>コーヒー豆くんのおすすめ</h2>
          <p id="recommendDesc">あなたの好みに合わせたおすすめ順で表示しています。</p>
          <button class="btn-reset" id="backToChat">チャットに戻る</button>
        </div>
        <div class="grid" id="recommendGrid"></div>
      </section>

      <section class="section" id="allBeansSection">
        <div class="section-header">
          <h2>代表的なコーヒー豆</h2>
          <p>初心者でも選びやすい20種類を、特徴・精製・等級も添えて紹介。</p>
        </div>

        <div class="grid">
          <article class="card">
            <div class="card-header">
              <h3>ブラジル</h3>
              <span class="tag">南米</span>
            </div>
            <p class="desc">バランス型。ナッツの雰囲気で飲みやすい。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 3"></div>
                <span class="score">3</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>パルプドナチュラル</li>
              <li><span class="meta-label">焙煎</span>中煎り〜中深煎り</li>
              <li><span class="meta-label">等級</span>No.2（欠点数）</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>コロンビア</h3>
              <span class="tag">南米</span>
            </div>
            <p class="desc">カシスや赤ワインのような豊潤さ。万能タイプ。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>中深煎りが定番</li>
              <li><span class="meta-label">等級</span>スプレモ / エクセルソ</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>グアテマラ</h3>
              <span class="tag">中米</span>
            </div>
            <p class="desc">ピスタチオのようなナッツ感とクリーンさ。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド</li>
              <li><span class="meta-label">焙煎</span>中煎りでバランス良</li>
              <li><span class="meta-label">等級</span>SHB / HB / SH</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>エチオピア</h3>
              <span class="tag">アフリカ</span>
            </div>
            <p class="desc">紅茶のように華やか。フローラルな香り。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 8"></div>
                <span class="score">8</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ナチュラル / ウォッシュド</li>
              <li><span class="meta-label">焙煎</span>浅煎りでも個性が残る</li>
              <li><span class="meta-label">等級</span>G1 / G2 / G3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ケニア</h3>
              <span class="tag">アフリカ</span>
            </div>
            <p class="desc">弾ける酸味とジューシーさ。深煎りも濃厚。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 9"></div>
                <span class="score">9</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>浅煎りで果実感が際立つ</li>
              <li><span class="meta-label">等級</span>AA / A / B</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>タンザニア</h3>
              <span class="tag">アフリカ</span>
            </div>
            <p class="desc">キレのある酸味。深煎りでも後味が軽い。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>浅煎り〜深煎り幅広く</li>
              <li><span class="meta-label">等級</span>AA / A / B</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>インドネシア</h3>
              <span class="tag">アジア</span>
            </div>
            <p class="desc">アーシーで個性的。深煎りで濃厚なコク。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 3"></div>
                <span class="score">3</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 8"></div>
                <span class="score">8</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 8"></div>
                <span class="score">8</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>スマトラ式が有名</li>
              <li><span class="meta-label">焙煎</span>深煎りでコク重視</li>
              <li><span class="meta-label">等級</span>G1 / G2 / G3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>コスタリカ</h3>
              <span class="tag">中米</span>
            </div>
            <p class="desc">甘さと酸味のバランスが良い。赤ワイン系の雰囲気。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ハニー（ブラック等）</li>
              <li><span class="meta-label">焙煎</span>中煎りで甘さが出る</li>
              <li><span class="meta-label">等級</span>SHB / HGA</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ニカラグア</h3>
              <span class="tag">中米</span>
            </div>
            <p class="desc">グレープフルーツ系の明るい酸味。クリーン。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>浅煎りで酸が綺麗</li>
              <li><span class="meta-label">等級</span>SHG / HG / MG</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>中国</h3>
              <span class="tag">アジア</span>
            </div>
            <p class="desc">多様な精製で個性が急増中。フルーツ感の幅が広い。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>アナエロビック等が多彩</li>
              <li><span class="meta-label">焙煎</span>中煎りで香りを重視</li>
              <li><span class="meta-label">等級</span>表記は多様</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ベトナム</h3>
              <span class="tag">アジア</span>
            </div>
            <p class="desc">ロブスタのパンチ。近年はファインロブスタも。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 3"></div>
                <span class="score">3</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>主にロブスタ</li>
              <li><span class="meta-label">焙煎</span>中深煎りでパンチ</li>
              <li><span class="meta-label">等級</span>G1 / G2 / G3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ホンジュラス</h3>
              <span class="tag">中米</span>
            </div>
            <p class="desc">ハーブやナッツの印象。優しい飲み口。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>中煎りでバランス</li>
              <li><span class="meta-label">等級</span>SHG / HG / CS</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ペルー</h3>
              <span class="tag">南米</span>
            </div>
            <p class="desc">マイルドでナッツ感。飲みやすいバランス型。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>中深煎りでまろやか</li>
              <li><span class="meta-label">等級</span>G1 / G2 / G3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>エルサルバドル</h3>
              <span class="tag">中米</span>
            </div>
            <p class="desc">蜂蜜のような柔らかい甘さ。パカマラ種が有名。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>浅煎りで甘さが映える</li>
              <li><span class="meta-label">等級</span>SHG / HG / CS</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ルワンダ</h3>
              <span class="tag">アフリカ</span>
            </div>
            <p class="desc">みかんのような明るい酸味。ジューシー。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>浅煎りで果実感</li>
              <li><span class="meta-label">等級</span>G1 / G2 / G3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ブルンジ</h3>
              <span class="tag">アフリカ</span>
            </div>
            <p class="desc">明るい酸味と甘さのバランス。上品な印象。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド中心</li>
              <li><span class="meta-label">焙煎</span>中煎りでバランス</li>
              <li><span class="meta-label">等級</span>AA / A / B</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>イエメン</h3>
              <span class="tag">中東</span>
            </div>
            <p class="desc">モカ・マタリで有名。赤ワインのような気品。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>情報は産地で様々</li>
              <li><span class="meta-label">焙煎</span>中煎り〜深煎り向き</li>
              <li><span class="meta-label">等級</span>地域名で呼ばれる</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ジャマイカ</h3>
              <span class="tag">カリブ</span>
            </div>
            <p class="desc">ブルーマウンテンで有名。爽やかで非常に上品。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 5"></div>
                <span class="score">5</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ウォッシュド</li>
              <li><span class="meta-label">焙煎</span>中煎りが定番</li>
              <li><span class="meta-label">等級</span>No.1 / No.2 / No.3</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>ラオス</h3>
              <span class="tag">アジア</span>
            </div>
            <p class="desc">柔らかい酸味とマイルドさ。キレの良い苦味。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 4"></div>
                <span class="score">4</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>情報は産地で様々</li>
              <li><span class="meta-label">焙煎</span>深煎り寄りでキレ</li>
              <li><span class="meta-label">等級</span>表記は少なめ</li>
            </ul>
          </article>

          <article class="card">
            <div class="card-header">
              <h3>モカ</h3>
              <span class="tag">エチオピア / イエメン</span>
            </div>
            <p class="desc">華やかでワインのような余韻。独特の香りが魅力。</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: 7"></div>
                <span class="score">7</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: 6"></div>
                <span class="score">6</span>
              </div>
            </div>
            <ul class="meta">
              <li><span class="meta-label">精製</span>ナチュラル / ウォッシュド</li>
              <li><span class="meta-label">焙煎</span>中煎りで香り重視</li>
              <li><span class="meta-label">等級</span>産地ごとに異なる</li>
            </ul>
          </article>
        </div>
      </section>

      <section class="section tips">
        <div class="section-header">
          <h2>選び方のコツ</h2>
          <p>迷ったらこの3つだけ覚えればOK。</p>
        </div>
        <div class="tips-grid">
          <div class="tip">
            <h4>酸味が苦手なら</h4>
            <p>「酸味 1〜4」の豆を選ぶと飲みやすい。</p>
          </div>
          <div class="tip">
            <h4>しっかりした味が好きなら</h4>
            <p>「味の濃さ 7〜10」「焙煎度 7〜10」を目安に。</p>
          </div>
          <div class="tip">
            <h4>迷ったらバランス型</h4>
            <p>ブラジルやコロンビアは失敗しにくい。</p>
          </div>
          <div class="tip">
            <h4>精製で印象が変わる</h4>
            <p>ナチュラルは個性、ウォッシュドはすっきり。</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>
          このページは学習用のサンプルです。豆の特徴は一般的な傾向として記載しています。
          参考: https://youtu.be/sB3Xst58ASA
        </p>
      </div>
    </footer>

    <!-- 動画モーダル制御スクリプト -->
    <script>
      (function() {
        const video = document.getElementById('introVideo');
        const videoModal = document.getElementById('videoModal');
        const closeBtn = document.getElementById('closeVideoModal');
        const skipBtn = document.getElementById('skipVideoBtn');
        const soundBtn = document.getElementById('videoSoundBtn');

        let isMuted = true;

        // モーダルを閉じる
        function closeVideoModal() {
          videoModal.classList.remove('is-active');
          video.pause();
          video.muted = true;
          document.body.style.overflow = '';
        }

        // 閉じるボタン
        closeBtn.addEventListener('click', closeVideoModal);

        // スキップボタン
        skipBtn.addEventListener('click', closeVideoModal);

        // 音声ボタン
        soundBtn.addEventListener('click', () => {
          isMuted = !isMuted;
          video.muted = isMuted;
          soundBtn.textContent = isMuted ? '🔇 音声ON' : '🔊 音声OFF';
        });

        // 動画終了時に自動で閉じる
        video.addEventListener('ended', closeVideoModal);

        // 初期状態でbodyのスクロールを無効化
        if (videoModal.classList.contains('is-active')) {
          document.body.style.overflow = 'hidden';
        }
      })();
    </script>

    <!-- チャットモーダル -->
    <div class="chat-modal-overlay" id="chatModal">
      <div class="chat-modal">
        <div class="chat-modal-header">
          <h2>コーヒー豆くんとチャット</h2>
          <button class="chat-modal-close" id="closeChatModal" aria-label="閉じる">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
          <!-- メッセージがここに追加される -->
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="chatInput" placeholder="メッセージを入力..." />
          <button class="chat-send-btn" id="chatSendBtn">送信</button>
        </div>
      </div>
    </div>

    <script>
      // ===== 共有ユーティリティ（検索・チャット両方で使用） =====
      const allBeansSection = document.getElementById('allBeansSection');

      // 既存カードからデータを抽出
      function extractBeanData() {
        const cards = allBeansSection.querySelectorAll('.card');
        const beans = [];

        cards.forEach((card, index) => {
          const name = card.querySelector('h3').textContent;
          const tag = card.querySelector('.tag').textContent;
          const desc = card.querySelector('.desc').textContent;
          const ratings = card.querySelectorAll('.rating');
          const meta = card.querySelectorAll('.meta li');

          const acidity = parseInt(ratings[0].querySelector('.score').textContent);
          const body = parseInt(ratings[1].querySelector('.score').textContent);
          const roast = parseInt(ratings[2].querySelector('.score').textContent);

          const metaInfo = [];
          meta.forEach(li => {
            metaInfo.push({
              label: li.querySelector('.meta-label').textContent,
              value: li.textContent.replace(li.querySelector('.meta-label').textContent, '')
            });
          });

          beans.push({
            index,
            name,
            tag,
            desc,
            acidity,
            body,
            roast,
            meta: metaInfo,
            element: card
          });
        });

        return beans;
      }

      // カードHTMLを生成
      function createCardHTML(bean) {
        return `
          <article class="card">
            <div class="card-header">
              <h3>${bean.name}</h3>
              <span class="tag">${bean.tag}</span>
            </div>
            <p class="desc">${bean.desc}</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: ${bean.acidity}"></div>
                <span class="score">${bean.acidity}</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: ${bean.body}"></div>
                <span class="score">${bean.body}</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: ${bean.roast}"></div>
                <span class="score">${bean.roast}</span>
              </div>
            </div>
            <ul class="meta">
              ${bean.meta.map(m => `<li><span class="meta-label">${m.label}</span>${m.value}</li>`).join('')}
            </ul>
          </article>
        `;
      }

      // おすすめカードHTMLを生成（理由タグ付き）
      function createRecommendCardHTML(bean, reasonTags) {
        return `
          <article class="card">
            <div class="card-header">
              <h3>${bean.name}</h3>
              <span class="tag">${bean.tag}</span>
            </div>
            <div class="reason-tags">
              ${reasonTags.map(t => `<span class="reason-tag">${t}</span>`).join('')}
            </div>
            <p class="desc">${bean.desc}</p>
            <div class="ratings">
              <div class="rating">
                <span>酸味</span>
                <div class="bar" style="--value: ${bean.acidity}"></div>
                <span class="score">${bean.acidity}</span>
              </div>
              <div class="rating">
                <span>味の濃さ</span>
                <div class="bar" style="--value: ${bean.body}"></div>
                <span class="score">${bean.body}</span>
              </div>
              <div class="rating">
                <span>焙煎度</span>
                <div class="bar" style="--value: ${bean.roast}"></div>
                <span class="score">${bean.roast}</span>
              </div>
            </div>
            <ul class="meta">
              ${bean.meta.map(m => `<li><span class="meta-label">${m.label}</span>${m.value}</li>`).join('')}
            </ul>
          </article>
        `;
      }

      // 距離計算（共通）
      function calculateDistance(bean, criteria) {
        let distance = 0;
        if (criteria.acidity !== null) {
          distance += Math.abs(bean.acidity - criteria.acidity);
        }
        if (criteria.body !== null) {
          distance += Math.abs(bean.body - criteria.body);
        }
        if (criteria.roast !== null) {
          distance += Math.abs(bean.roast - criteria.roast);
        }
        return distance;
      }

      // 理由タグ自動生成
      function generateReasonTags(bean, target) {
        const tags = [];

        if (target.acidity !== null) {
          if (Math.abs(bean.acidity - target.acidity) <= 1) tags.push('酸味ぴったり');
          else if (bean.acidity <= 3) tags.push('酸味ひかえめ');
          else if (bean.acidity >= 7) tags.push('酸味しっかり');
        }

        if (target.body !== null) {
          if (Math.abs(bean.body - target.body) <= 1) tags.push('濃さぴったり');
          else if (bean.body <= 3) tags.push('あっさり');
          else if (bean.body >= 7) tags.push('しっかり濃い');
        }

        if (target.roast !== null) {
          if (Math.abs(bean.roast - target.roast) <= 1) tags.push('焙煎ぴったり');
          else if (bean.roast <= 3) tags.push('浅煎り');
          else if (bean.roast >= 7) tags.push('深煎り');
        }

        if (tags.filter(t => t.includes('ぴったり')).length === 3) {
          return ['完全一致！'];
        }

        const sorted = tags.sort((a, b) => {
          const aPriority = a.includes('ぴったり') ? 0 : 1;
          const bPriority = b.includes('ぴったり') ? 0 : 1;
          return aPriority - bPriority;
        });

        return sorted.slice(0, 2);
      }

      // ===== 検索機能 =====
      (function () {
        // 要素の取得
        const openModalBtn = document.getElementById('openSearchModal');
        const closeModalBtn = document.getElementById('closeModal');
        const backBtn = document.getElementById('backBtn');
        const searchBtn = document.getElementById('searchBtn');
        const modal = document.getElementById('searchModal');
        const searchError = document.getElementById('searchError');
        const resetSearchBtn = document.getElementById('resetSearch');
        const searchResultsSection = document.getElementById('searchResultsSection');
        const searchResultsGrid = document.getElementById('searchResultsGrid');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        const searchResultsDesc = document.getElementById('searchResultsDesc');
        const recommendSection = document.getElementById('recommendSection');

        // 選択状態
        const selectedCriteria = {
          acidity: null,
          body: null,
          roast: null
        };

        // 距離計算（検索用ラッパー - 共通関数を使用）
        // calculateDistance は共有スコープの関数を使用

        // 検索実行
        function performSearch() {
          const hasSelection = selectedCriteria.acidity !== null ||
                               selectedCriteria.body !== null ||
                               selectedCriteria.roast !== null;

          if (!hasSelection) {
            searchError.textContent = '1項目以上選択してください';
            return;
          }

          searchError.textContent = '';
          const beans = extractBeanData();

          // 全件に距離を計算
          const beansWithDistance = beans.map(bean => ({
            ...bean,
            distance: calculateDistance(bean, selectedCriteria)
          }));

          // 距離順にソート（同距離は元の並び順）
          beansWithDistance.sort((a, b) => {
            if (a.distance !== b.distance) return a.distance - b.distance;
            return a.index - b.index;
          });

          // 完全一致（距離0）の件数をカウント
          const exactMatchCount = beansWithDistance.filter(bean => bean.distance === 0).length;

          // 検索条件の文字列を作成
          const criteriaText = [];
          if (selectedCriteria.acidity !== null) criteriaText.push(`酸味: ${selectedCriteria.acidity}`);
          if (selectedCriteria.body !== null) criteriaText.push(`味の濃さ: ${selectedCriteria.body}`);
          if (selectedCriteria.roast !== null) criteriaText.push(`焙煎度: ${selectedCriteria.roast}`);

          // 結果表示
          if (exactMatchCount > 0) {
            searchResultsTitle.textContent = `検索結果: ${exactMatchCount}件一致`;
            searchResultsDesc.textContent = `${criteriaText.join('、')} に一致・近い順で表示`;
          } else {
            searchResultsTitle.textContent = `検索結果`;
            searchResultsDesc.textContent = `${criteriaText.join('、')} に近い順で表示`;
          }

          searchResultsGrid.innerHTML = beansWithDistance.map(bean => createCardHTML(bean)).join('');

          // モーダルを閉じて検索結果を表示
          closeModal();
          searchResultsSection.style.display = 'block';
          allBeansSection.style.display = 'none';
          recommendSection.style.display = 'none';

          // 検索結果にスクロール
          searchResultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // モーダルを開く
        function openModal() {
          modal.classList.add('is-active');
          document.body.style.overflow = 'hidden';
        }

        // モーダルを閉じる
        function closeModal() {
          modal.classList.remove('is-active');
          document.body.style.overflow = '';
        }

        // 選択状態をリセット
        function resetSelection() {
          selectedCriteria.acidity = null;
          selectedCriteria.body = null;
          selectedCriteria.roast = null;
          document.querySelectorAll('.criteria-buttons button').forEach(btn => {
            btn.classList.remove('is-selected');
          });
          searchError.textContent = '';
        }

        // 検索結果をリセット
        function resetSearch() {
          searchResultsSection.style.display = 'none';
          recommendSection.style.display = 'none';
          allBeansSection.style.display = 'block';
          resetSelection();
        }

        // イベントリスナー
        openModalBtn.addEventListener('click', () => {
          resetSelection();
          openModal();
        });

        closeModalBtn.addEventListener('click', closeModal);
        backBtn.addEventListener('click', closeModal);

        // オーバーレイクリックで閉じる
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });

        // ESCキーで閉じる
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('is-active')) {
            closeModal();
          }
        });

        // 選択ボタンのトグル
        document.querySelectorAll('.criteria-buttons').forEach(group => {
          const criteria = group.dataset.criteria;

          group.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;

            const value = parseInt(e.target.dataset.value);

            // 同じボタンをクリックしたら解除
            if (selectedCriteria[criteria] === value) {
              selectedCriteria[criteria] = null;
              e.target.classList.remove('is-selected');
            } else {
              // 他のボタンの選択を解除
              group.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('is-selected');
              });
              // 新しく選択
              selectedCriteria[criteria] = value;
              e.target.classList.add('is-selected');
            }

            searchError.textContent = '';
          });
        });

        searchBtn.addEventListener('click', performSearch);
        resetSearchBtn.addEventListener('click', resetSearch);
      })();

      // ===== コーヒー豆くんチャット機能 =====
      (function () {
        // 要素の取得
        const openChatBtn = document.getElementById('openChatModal');
        const closeChatBtn = document.getElementById('closeChatModal');
        const chatModal = document.getElementById('chatModal');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const triviaText = document.getElementById('triviaText');
        const recommendSection = document.getElementById('recommendSection');
        const recommendGrid = document.getElementById('recommendGrid');
        const recommendDesc = document.getElementById('recommendDesc');
        const backToChatBtn = document.getElementById('backToChat');
        const searchResultsSection = document.getElementById('searchResultsSection');

        // 状態管理
        let isChatOpen = false;
        let chatHistory = [];
        let isSending = false;
        let currentTurnId = 0;
        let lastRecommendation = null;

        // システムプロンプト
        const SYSTEM_INSTRUCTION = {
          parts: [{
            text: `あなたは「コーヒー豆くん」です。

【キャラクター】
- 一人称は「コーヒー豆くん」
- 語尾は「〜なのだ」で話す
- ユーザーが英語で話しかけたら英語で返答する

【出力フォーマット（厳守）】
- 1行につき1文。文末ごとに改行する
- 箇条書き（- * ・）、見出し（#）、長文段落は絶対に使わない
- 原則4行以内（ユーザーが詳しい解説を求めた場合のみ例外的に増加可）

【おすすめ提示時のフォーマット】
- 具体的な豆名を1つでも提示するときは、会話テキストの後に以下を付ける:
  ---JSON---
  {"acidity":数値またはnull,"body":数値またはnull,"roast":数値またはnull,"topBean":"豆名"}
- acidity=酸味、body=味の濃さ、roast=焙煎度（各1〜10、推定できない場合はnull）
- topBeanはサイト内の豆名と完全一致させる
- 雑談・豆知識・質問返しのみの場合は ---JSON--- を付けない

【好み推定のルール】
- ユーザーの発話から酸味・濃さ・焙煎の好みを推定する
- 推定できない軸が残る場合、最も判別に効く軸を1つだけ「2択や選択肢」で質問する
- 質問返しのターンでは ---JSON--- を付けない

【データ制約】
- おすすめはサイト内の豆データのみで構成する
- ユーザーが明示的に「サイト外も含めて」等を要求した場合のみ、サイト外の豆を提案してよい（その場合「サイト外の提案」と明記する）

【サイト内の豆データ（20種）】
名前 | 地域 | 酸味 | 濃さ | 焙煎 | 特徴
ブラジル | 南米 | 3 | 6 | 6 | ナッツの雰囲気で飲みやすいバランス型
コロンビア | 南米 | 5 | 6 | 6 | カシスや赤ワインのような豊潤さ。万能
グアテマラ | 中米 | 5 | 6 | 5 | ピスタチオのようなナッツ感とクリーンさ
エチオピア | アフリカ | 8 | 4 | 5 | 紅茶のように華やか。フローラルな香り
ケニア | アフリカ | 9 | 7 | 5 | 弾ける酸味とジューシーさ
タンザニア | アフリカ | 6 | 6 | 6 | キレのある酸味。深煎りでも後味が軽い
インドネシア | アジア | 3 | 8 | 8 | アーシーで個性的。深煎りで濃厚なコク
コスタリカ | 中米 | 6 | 6 | 5 | 甘さと酸味のバランス。赤ワイン系
ニカラグア | 中米 | 6 | 5 | 4 | グレープフルーツ系の明るい酸味。クリーン
中国 | アジア | 6 | 6 | 5 | 多様な精製で個性が急増中。フルーツ感
ベトナム | アジア | 3 | 7 | 7 | ロブスタのパンチ。ファインロブスタも
ホンジュラス | 中米 | 4 | 6 | 5 | ハーブやナッツの印象。優しい飲み口
ペルー | 南米 | 4 | 5 | 5 | マイルドでナッツ感。飲みやすいバランス型
エルサルバドル | 中米 | 6 | 5 | 5 | 蜂蜜のような柔らかい甘さ。パカマラ種
ルワンダ | アフリカ | 7 | 5 | 4 | みかんのような明るい酸味。ジューシー
ブルンジ | アフリカ | 6 | 5 | 5 | 明るい酸味と甘さのバランス。上品
イエメン | 中東 | 6 | 7 | 7 | モカ・マタリで有名。赤ワインのような気品
ジャマイカ | カリブ | 5 | 5 | 5 | ブルーマウンテン。爽やかで非常に上品
ラオス | アジア | 4 | 6 | 6 | 柔らかい酸味とマイルドさ。キレの良い苦味
モカ | エチオピア/イエメン | 7 | 6 | 6 | 華やかでワインのような余韻`
          }]
        };

        // デフォルト豆知識
        const DEFAULT_TRIVIA = "コーヒーの木は赤道付近の「コーヒーベルト」と呼ばれる地域で栽培されているのだ！";

        // 豆知識を取得
        async function fetchTrivia() {
          try {
            const response = await fetch('/api/gemini', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{
                  role: 'user',
                  parts: [{ text: 'コーヒーに関する豆知識を1つ、50文字以内で「〜なのだ」口調で教えて。' }]
                }]
              })
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            const triviaResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (triviaResponse) {
              triviaText.textContent = triviaResponse;
            } else {
              triviaText.textContent = DEFAULT_TRIVIA;
            }
          } catch (error) {
            console.error('豆知識の取得に失敗:', error);
            triviaText.textContent = DEFAULT_TRIVIA;
          }
        }

        // 初期化: 豆知識を取得
        fetchTrivia();

        // --- AIレスポンスのパース ---

        // セパレータでテキストとJSONを分離
        function parseAIResponse(rawText) {
          const separator = '---JSON---';
          const parts = rawText.split(separator);
          const conversationText = parts[0];
          let recommendation = null;

          if (parts.length > 1) {
            try {
              recommendation = JSON.parse(parts[1].trim());
            } catch (e) {
              console.error('JSON パース失敗:', e);
            }
          }

          return { conversationText, recommendation };
        }

        // 会話テキストをふきだし配列に正規化
        function normalizeBubbles(text) {
          // 改行コード統一 → trim
          let normalized = text.replace(/\r\n/g, '\n').trim();

          // 改行でsplit → 空行除去
          let lines = normalized.split('\n').filter(line => line.trim() !== '');

          // 1行しか取れない場合、文末記号で保険分割
          if (lines.length === 1 && lines[0].length > 30) {
            const fallback = lines[0].split(/(?<=[。！？])/).filter(s => s.trim() !== '');
            if (fallback.length > 1) {
              lines = fallback;
            }
          }

          // 最大4行に丸める（超過分は末尾行に結合）
          if (lines.length > 4) {
            const first3 = lines.slice(0, 3);
            const rest = lines.slice(3).join('');
            lines = [...first3, rest];
          }

          return lines.map(line => line.trim()).filter(line => line !== '');
        }

        // --- メッセージ表示 ---

        // 単一のふきだしを追加
        function addBubble(role, text) {
          const messageDiv = document.createElement('div');
          messageDiv.className = `chat-message ${role}`;
          messageDiv.textContent = text;
          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          return messageDiv;
        }

        // ローディングメッセージを削除
        function removeLoadingMessage() {
          const loadingMsg = chatMessages.querySelector('.chat-message.loading');
          if (loadingMsg) {
            loadingMsg.remove();
          }
        }

        // ふきだしを300ms間隔で連投表示
        function displayBubblesSequentially(bubbles, turnId) {
          return new Promise((resolve) => {
            let i = 0;
            function showNext() {
              if (turnId !== currentTurnId) { resolve(); return; }
              if (i >= bubbles.length) { resolve(); return; }
              addBubble('assistant', bubbles[i]);
              i++;
              setTimeout(showNext, 300);
            }
            showNext();
          });
        }

        // --- おすすめ処理 ---

        // プレビューカードをチャット内に追加
        function addPreviewCard(topBeanData, target) {
          const reasonTags = generateReasonTags(topBeanData, target);

          const cardDiv = document.createElement('div');
          cardDiv.className = 'chat-recommend-card';
          cardDiv.innerHTML = `
            <div class="chat-recommend-header">
              <span class="chat-recommend-name">${topBeanData.name}</span>
              <span class="tag">${topBeanData.tag}</span>
            </div>
            <div class="chat-recommend-tags">
              ${reasonTags.map(t => `<span class="reason-tag">${t}</span>`).join('')}
            </div>
          `;
          chatMessages.appendChild(cardDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // CTAボタンをチャット内に追加
        function addCTAButton() {
          const ctaBtn = document.createElement('button');
          ctaBtn.className = 'chat-recommend-cta';
          ctaBtn.textContent = 'おすすめのコーヒー豆を見る';
          ctaBtn.addEventListener('click', showRecommendSection);
          chatMessages.appendChild(ctaBtn);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // おすすめデータを計算・保存
        function processRecommendation(rec) {
          const target = {
            acidity: rec.acidity ?? null,
            body: rec.body ?? null,
            roast: rec.roast ?? null
          };

          const beans = extractBeanData();
          const beansWithDistance = beans.map(bean => ({
            ...bean,
            distance: calculateDistance(bean, target)
          }));

          beansWithDistance.sort((a, b) => {
            if (a.distance !== b.distance) return a.distance - b.distance;
            return a.index - b.index;
          });

          const topBeanData = beans.find(b => b.name === rec.topBean) || null;

          lastRecommendation = {
            target,
            topBean: rec.topBean,
            sortedBeans: beansWithDistance
          };

          return { target, topBeanData, sortedBeans: beansWithDistance };
        }

        // おすすめ一覧セクションを表示
        function showRecommendSection() {
          if (!lastRecommendation) return;

          const { target, sortedBeans } = lastRecommendation;

          // カードを描画
          recommendGrid.innerHTML = sortedBeans.map(bean => {
            const tags = generateReasonTags(bean, target);
            return createRecommendCardHTML(bean, tags);
          }).join('');

          // セクション切り替え
          closeChatModal();
          allBeansSection.style.display = 'none';
          searchResultsSection.style.display = 'none';
          recommendSection.style.display = 'block';
          recommendSection.scrollIntoView({ behavior: 'smooth' });
        }

        // 「チャットに戻る」ボタン
        backToChatBtn.addEventListener('click', () => {
          recommendSection.style.display = 'none';
          allBeansSection.style.display = 'block';
          openChatModal();
        });

        // --- Gemini API ---

        async function callGeminiAPI() {
          const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: chatHistory,
              systemInstruction: SYSTEM_INSTRUCTION
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          return data.candidates?.[0]?.content?.parts?.[0]?.text || 'うまく返事できなかったのだ...';
        }

        // --- メッセージ送信 ---

        async function sendMessage() {
          const message = chatInput.value.trim();
          if (!message || isSending) return;

          // 送信中状態に
          isSending = true;
          chatSendBtn.disabled = true;
          chatInput.disabled = true;

          // turnId発行
          currentTurnId++;
          const myTurnId = currentTurnId;

          // ユーザーメッセージを表示
          addBubble('user', message);
          chatInput.value = '';

          // 履歴に追加
          chatHistory.push({ role: 'user', parts: [{ text: message }] });

          // ローディング表示
          const loadingMsg = addBubble('assistant', '考え中なのだ...');
          loadingMsg.classList.add('loading');

          try {
            const rawResponse = await callGeminiAPI();

            // turnIdチェック（古い返答は無視）
            if (myTurnId !== currentTurnId) return;

            // ローディングを削除
            removeLoadingMessage();

            // レスポンスをパース
            const { conversationText, recommendation } = parseAIResponse(rawResponse);

            // 履歴に追加（生テキスト全体を保存）
            chatHistory.push({ role: 'model', parts: [{ text: rawResponse }] });

            // ふきだし配列に正規化
            const bubbles = normalizeBubbles(conversationText);

            // 連投表示（300ms間隔）
            await displayBubblesSequentially(bubbles, myTurnId);

            // turnIdチェック
            if (myTurnId !== currentTurnId) return;

            // おすすめ処理（JSONがある場合）
            if (recommendation && recommendation.topBean) {
              const { target, topBeanData } = processRecommendation(recommendation);

              // プレビューカード（topBeanがサイト内に見つかる場合のみ）
              if (topBeanData) {
                addPreviewCard(topBeanData, target);
              }

              // CTAボタン（常に表示）
              addCTAButton();
            }
          } catch (error) {
            console.error('API呼び出しエラー:', error);
            if (myTurnId !== currentTurnId) return;
            removeLoadingMessage();
            addBubble('assistant', 'うまく返事できなかったのだ...もう一度試してほしいのだ。');
          } finally {
            // 送信状態をリセット
            isSending = false;
            chatSendBtn.disabled = false;
            chatInput.disabled = false;
            chatInput.focus();
          }
        }

        // --- モーダル制御 ---

        function openChatModal() {
          chatModal.classList.add('is-active');
          document.body.style.overflow = 'hidden';
          isChatOpen = true;
          chatInput.focus();
        }

        function closeChatModal() {
          chatModal.classList.remove('is-active');
          document.body.style.overflow = '';
          isChatOpen = false;
        }

        // イベントリスナー
        openChatBtn.addEventListener('click', openChatModal);
        closeChatBtn.addEventListener('click', closeChatModal);

        chatModal.addEventListener('click', (e) => {
          if (e.target === chatModal) {
            closeChatModal();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && isChatOpen) {
            closeChatModal();
          }
        });

        chatSendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      })();
    </script>
  </body>
</html>
