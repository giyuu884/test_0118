# コーヒー豆くん 会話UX改良（短文＋おすすめTop3導線）設計書

## 1. 目的
現状の「長文＋カード大量表示」による読みづらさを解消し、会話としてテンポ良く進み、必要なときに「おすすめ一覧」を行動（ボタン）で見せる体験に改良する。

本改良では特に以下を実現する：

- **会話は短文**（基本2文以内）でテンポを作る
- **おすすめはTop3**に固定して会話が長くならないようにする
- **会話→一覧**を「おすすめのコーヒー豆をみる」ボタンで接続する（同ページ内の検索結果セクションを流用）
- LLM出力の揺れがあってもUIが壊れないように、**UIが扱える形（`【豆名】`）に制約**する

## 2. 対象範囲
- 対象画面: `search_coffee/index.html` のチャットモーダル、および検索結果セクション（`#searchResultsSection`）
- 対象スタイル: `search_coffee/styles.css`

## 3. 目標UX（確定）
- **チャットUI**: バブル型（現状維持）
- **返答文量**: 基本2文以内。ただしユーザーが「詳しく」と言ったときのみ長文を許可
- **おすすめ提示**: Top3固定
- **導線**: チャット内に「おすすめのコーヒー豆をみる」ボタンを表示し、押下で同ページ内の `#searchResultsSection` におすすめTop3を表示してスクロール（疑似ページ遷移）
- **チップUI**: 導入しない（自由入力を基本とする）

## 4. 情報設計（会話と表示の責務分離）
### 4.1 会話（チャット）の役割
- ユーザーの要望（気分・味の好み）を引き出す
- 次の行動（おすすめ一覧を見る）へ誘導する
- おすすめは「候補の羅列」をしない（Top3のみ）

### 4.2 一覧（検索結果セクション）の役割
- 「おすすめTop3」をカードUIでまとめて見せる
- 既存の検索結果UIを流用し、表示の統一感を保つ

## 5. 会話設計（状態・分岐）
### 5.1 状態
- **NormalChat**: 通常の会話（おすすめ確定なし）
- **RecommendationReady**: おすすめTop3が確定し、CTAが表示可能

### 5.2 分岐条件（RecommendationReadyの成立条件）
LLM返答テキストから `【豆名】` を抽出し、以下を満たした場合におすすめ確定とする：

- **既知の豆名**（ページ内カード由来の豆）に一致する `【豆名】` が **3件以上**抽出できる
- 直近のユーザー入力または返答に **おすすめ意図**が含まれる（例: 「おすすめ」「オススメ」「recommend」）

確定した場合は、抽出順（おすすめ順）で **Top3** を `lastRecommendations` に保持する。

## 6. UI仕様
### 6.1 おすすめ確定時のチャット表示
おすすめ確定時は、チャット内カードを出さずに以下を表示する：

- **短文（2文）**のおすすめメッセージ（UI側で生成し、テンポを保証）
- 「おすすめのコーヒー豆をみる」ボタン（CTA）

おすすめメッセージ生成例：
- `だったら【ブラジル】がおすすめなのだ！ほかにも【エチオピア】と【コロンビア】が合いそうなのだ。`

### 6.2 CTA押下後の表示
CTA押下で以下を行う：

- チャットモーダルを閉じる（結果表示に集中できるようにする）
- `#searchResultsSection` を表示し、`#allBeansSection` を非表示
- `#searchResultsTitle` / `#searchResultsDesc` を「豆くんおすすめTop3」向け文言に更新
- `#searchResultsGrid` におすすめTop3カードをおすすめ順で描画
- `scrollIntoView({behavior:'smooth'})` で検索結果セクションへスクロール

## 7. LLM仕様（出力制約）
### 7.1 基本口調
- 一人称: コーヒー豆くん
- 語尾: 〜なのだ
- 英語入力時: 英語返答

### 7.2 返答の長さ
- 既定: **基本2文以内**
- 例外: ユーザー入力に「詳しく/詳細/もっと詳しく」等が含まれる場合は長文を許可

### 7.3 おすすめ時の出力フォーマット
おすすめを出す場合は、返答本文に以下を必ず満たす形で含める：

- `【豆名】` が **必ず3つ**入る
- **それ以上の豆名を出さない**
- **おすすめ順**で3つ並ぶ（抽出順をランキングとして扱う）

## 8. フォールバック（LLM揺れ対策）
- `【豆名】` が3件揃わない場合: おすすめ未確定扱い（CTAなし）
- 存在しない豆名が混ざる場合: UI側で照合して除外し、3件揃わなければおすすめ未確定扱い
- 返答が冗長な場合: 既知の豆名が含まれない通常会話に限り、UI側で2文相当に短縮して表示（詳細要求時は短縮しない）

## 9. 実装メモ（どこで何をしているか）
- `index.html`（チャットIIFE内）\n+  - `buildSystemInstruction(beans,{allowLong})` で「短文＋Top3」制約を付与\n+  - `findMentionedBeans()` で `【豆名】` 抽出（既知の豆のみ）\n+  - おすすめ確定時: `lastRecommendations` を設定し、CTA付きメッセージを表示\n+  - CTA押下: `showRecommendations()` で `#searchResultsSection` をおすすめTop3で描画\n+- `styles.css`\n+  - `.chat-actions` / `.chat-action-btn` を追加し、チャット内CTAを既存トーンで表示\n+
## 10. 手動テスト観点
- 「おすすめ教えて」→ 追加質問→ 好み入力→ 短文＋CTAが出る
- CTA押下で検索結果セクションに「おすすめTop3」が表示される（おすすめ順）
- 既存の検索モーダル検索が壊れていない
- 「詳しく」と言った時だけ長めの返答が許容される

