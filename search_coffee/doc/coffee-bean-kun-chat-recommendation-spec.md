## コーヒー豆くん：チャットUX（LINE感）＆おすすめ選定 設計書

### このドキュメントの位置づけ
- `coffee-bean-kun-spec.md` / `coffee-bean-kun-impl-spec.md` のうち、**会話体験のテンポ改善**と **おすすめ提示のロジック**を明確化する補助設計書。
- ここで扱うのは **UI/UX要件** と **推薦ロジック**。勝手な実装変更は含めない。

---

## 目的（UXの狙い）
- 長文で一方的に紹介するのではなく、**短いふきだしの往復で会話を成立**させる。
- その場で説明を詰め込まず、必要な情報量は **おすすめ一覧ページ**に寄せる。
- 推薦の根拠をユーザーが納得できるように、一覧で **理由タグ**を提示する。

---

## スコープ
### 含む
- **LINE感**: 1行 = 1ふきだし（連投表示）
- 返答テンポ: 原則 **1〜4行（= 1〜4ふきだし）**
- チャット内おすすめ: **プレビューカード1枚** + **おすすめ一覧CTA**
- おすすめ一覧: **別ページ**（デザイン統一）で **おすすめ順** + **理由タグ**
- 豆の選定ロジック: 「ユーザー発話 → 3軸（酸味/濃さ/焙煎）推定 → 距離で並べ替え」＋タグ一致
- データ制約: **今回はサイト内の豆データのみ**（ユーザーが明示要求した場合のみ外部知識を許可）

### 含まない（非スコープ）
- 具体的なUI実装コードやコンポーネント分割（別ドキュメント/実装で扱う）
- 外部情報源の取得・スクレイピング等（将来拡張）

---

## 画面・導線（確定）
### チャット
- 表示: 右から出るチャットモーダル（既存の方針を踏襲）
- 表示形式: **1行=1ふきだし**（LINE風）
- 返答: 原則 1〜4行（解説要求時のみ例外として行数増加を許容）

### おすすめ一覧
- **別ページに遷移**する（戻るとチャットへ戻る）
- 一覧ページは既存トーン（色・余白・角丸・フォント・カード）に統一
- 一覧は「コーヒー豆くんオリジナルのおすすめ順」で並ぶ
- 各豆に **理由タグ**を表示する（例: 「ナッツ寄り」「酸味ひかえめ」「中煎り」）

---

## LINE感（1行=1ふきだし）を“確実に”する設計
狙いは、AIの返答が長文になったり文分割がブレたりしても、**表示が必ずLINEっぽくなる**こと。

### 基本方針（最重要）
- AI出力に「**改行区切り**」というフォーマット契約を作る
- フロントは「改行でsplit → 1行ずつふきだし追加」のみで描画する
- AIが契約を破った場合の保険として、フロントで文末記号分割（`。！？`）を使う

### AI出力の契約（推奨プロンプト要件）
- 1行につき1文
- 文末ごとに改行
- 最大4行（例外: ユーザーが解説要求した場合のみ行数増加可）
- 箇条書き/見出し/長文段落を避ける

#### 期待する出力例
```text
【ブラジル】がおすすめなのだ！
ナッツっぽくて飲みやすい方向なのだ！
近い候補もまとめて出すのだ！
一覧も見るのだ？
```

### フロント側の正規化（壊れた時の保険）
1. 改行コードを統一（`\r\n` → `\n`）
2. 前後trim / 空行除去
3. まず改行でsplit
4. もし 1行しか取れないなど崩れたら、文末記号（`。！？`）で保険分割
5. 最終的に **最大4行**に丸める（超過分は末尾行に結合する等）

### 連投表示（LINEっぽさの演出）
- ふきだしは配列順に **順次追加**する
- 1つ追加するごとに最下部へスクロール
- ふきだし間の待機（例: 200〜400ms）で「連投感」を作る

### 順序保証（“確実”の最後の砦）
- 送信ごとに `turnId` を発行
- 返答が戻ったら「最新turnId以外は描画しない」
- 新規送信開始時に、前回の連投描画を中断できる仕組みを用意する（表示の割り込み防止）

---

## チャット内おすすめ表示（プレビュー1枚 + CTA）
### 表示タイミング（確定）
- **具体的な豆名を1つでも提示したターン**では必ずCTAを出す

### 表示内容（推奨）
- **プレビューカード（1枚）**
  - 豆名
  - 地域タグ（既存の`.tag`に合わせる）
  - 理由タグ 1〜2個（短く）
  - 「詳しく」リンク（任意: 一覧ページで該当豆にスクロール等）
- **CTAボタン**
  - 文言: 「おすすめのコーヒー豆を見る」
  - 動作: おすすめ一覧ページへ遷移（同一デザイン言語）

---

## 豆の選定ロジック（おすすめの出し方）
既存の検索仕様（`search-modal-spec.md`）の「距離=絶対差の合計」を踏襲し、理解しやすさと一貫性を優先する。

### 使う情報は2系統
- **数値（3軸）**: `acidity`, `body`, `roast`（1〜10、推定できない場合はnull）
- **言葉タグ**: `nutty` / `floral` / `chocolate` / `clean` / `easy` など（短いラベル）

### 手順（概念）
1. ユーザー発話から、3軸を推定して「目標値」を作る（不明はnull）
2. 全豆（サイト内）に対して距離を計算する
3. 距離が小さい順に並べる（同距離は次の規則で決める）
4. 同距離の場合は **タグ一致数が多い豆**を上位に（同率なら元の並び順）
5. 上位のうち、チャットに出すのは **トップ1**（プレビュー）
6. 一覧は「おすすめ順（=上記の並び）」で表示

### 距離の定義（既存仕様と同じ）
- 距離は **推定できた項目のみ**で計算する
- 距離 = \(|酸味差| + |濃さ差| + |焙煎度差|\)

例）目標が（酸味=3、濃さ=6、焙煎=6）なら、豆が（3,6,6）で距離0。

---

## 「足りない1点だけ聞く」会話ルール（4)Bの具体）
### 目的
- 推定の精度を上げつつ、会話のテンポを落とさない。

### ルール
- ユーザー発話から推定できた軸は埋める
- 未確定が残る場合、**最も判別に効く軸を1つだけ**質問する
- 質問は「答えやすい形（2択や短い選択肢）」を優先する

例）
- 「飲みやすい」だけ → 「酸味は苦手なのだ？それとも爽やかな方が好きなのだ？」
- 「深煎りが好き」 → 残りの軸を1つだけ（例: 濃さ）

---

## データソースの制約（今回はサイト内のみ）
### 基本
- 推薦・一覧は **サイト内に存在する豆データ**のみで構成する（カードから抽出したデータを母集団とする）

### 例外（外部知識の解禁条件）
- ユーザーが明示的に「サイト外も含めて」等を要求した場合のみ、AIがサイト外の豆を提案してよい
- その場合は **「サイト外の提案」であることを明記**する（誤認防止）

---

## 一覧ページの表示要件（デザイン統一）
- 既存のCSS変数（`--accent`, `--surface`, `--line`, `--accent-soft` 等）を使用
- 既存のカードスタイル（`.card`）を踏襲し、視覚的な統一感を維持
- 追加要素（理由タグ等）は `.tag` と整合する見た目にする

---

## 例外・エラー時の扱い
- AI応答が空/不正:
  - チャットに「うまく返事できなかったのだ…」を表示
  - LINE感は維持（この文は1行1ふきだし）
- 応答が長すぎる:
  - 最大4行に丸め、超過分は末尾行へ結合（もしくは「続きは一覧で」へ誘導）
- 連続送信/遅延:
  - `turnId` による順序保証で、古い返答の割り込み表示を防ぐ

---

## 合意事項（本設計の“確定”）
- LINE感: **1行=1ふきだし**、返答は原則 **1〜4行**
- 遷移: CTA押下で **別ページ**のおすすめ一覧へ（戻るとチャットへ）
- チャット内: **おすすめプレビューは1枚** + **CTA**
- 一覧: **理由タグ（B）** を表示
- 質問: **推定して足りない1点だけ聞く（B）**
- データ: **今回はサイト内のみ**、ユーザー明示要求時のみサイト外提案を許可

